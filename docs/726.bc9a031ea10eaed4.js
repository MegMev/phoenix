"use strict";(self.webpackChunkphoenix_app=self.webpackChunkphoenix_app||[]).push([[726],{9726:(x,B,s)=>{s.r(B),s.d(B,{TASImagePainter:()=>c});var m=s(1773),d=s(263),I=s(2454),D=s(6902),M=s(1518);class c extends I.tK{decodeOptions(t){this.options={Zscale:!1},t&&t.indexOf("z")>=0&&(this.options.Zscale=!0)}createRGBA(t){let r=this.getObject();if(!(null==r?void 0:r.fPalette))return null;let a=new Array(4*(t+1)),e=1,l=r.fPalette;for(let i=0;i<=t;++i){let n=1*i/t;for(;l.fPoints[e]<n&&e<l.fPoints.length-1;)e++;let g=(l.fPoints[e]-n)/(l.fPoints[e]-l.fPoints[e-1]),h=(n-l.fPoints[e-1])/(l.fPoints[e]-l.fPoints[e-1]);a[4*i]=Math.min(255,Math.round((l.fColorRed[e-1]*g+l.fColorRed[e]*h)/256)),a[4*i+1]=Math.min(255,Math.round((l.fColorGreen[e-1]*g+l.fColorGreen[e]*h)/256)),a[4*i+2]=Math.min(255,Math.round((l.fColorBlue[e-1]*g+l.fColorBlue[e]*h)/256)),a[4*i+3]=Math.min(255,Math.round((l.fColorAlpha[e-1]*g+l.fColorAlpha[e]*h)/256))}return a}makeUrlFromImageBuf(t,r){this.rgba=this.createRGBA(1e3);let e=t.fImgBuf[0],l=t.fImgBuf[0];for(let o=1;o<t.fImgBuf.length;++o){let f=t.fImgBuf[o];e=Math.min(f,e),l=Math.max(f,l)}this.fContour={arr:new Array(200),rgba:this.rgba,getLevels(){return this.arr},getPaletteColor(o,f){if(!this.arr||!this.rgba)return"white";let u=4*Math.round((f-this.arr[0])/(this.arr[this.arr.length-1]-this.arr[0])*(this.rgba.length-4)/4);return"#"+(0,d.NC)(this.rgba[u],1)+(0,d.NC)(this.rgba[u+1],1)+(0,d.NC)(this.rgba[u+2],1)+(0,d.NC)(this.rgba[u+3],1)}};for(let o=0;o<200;o++)this.fContour.arr[o]=e+(l-e)/199*o;e>=l&&(l=e+1);let i=0,n=t.fWidth,g=0,h=t.fHeight;return r&&r.zoom_xmin!=r.zoom_xmax&&(i=Math.round(r.zoom_xmin*t.fWidth),n=Math.round(r.zoom_xmax*t.fWidth)),r&&r.zoom_ymin!=r.zoom_ymax&&(g=Math.round(r.zoom_ymin*t.fHeight),h=Math.round(r.zoom_ymax*t.fHeight)),((0,m.isNodeJs)()?s.e(305).then(s.t.bind(s,8305,19)).then(o=>o.default.createCanvas(n-i,h-g)):new Promise(o=>{let f=document.createElement("canvas");f.width=n-i,f.height=h-g,o(f)})).then(o=>{let f=o.getContext("2d"),u=f.getImageData(0,0,o.width,o.height),P=u.data;for(let b=g;b<h;++b){let _=(h-b-1)*(n-i)*4,w=b*t.fWidth;for(let p=i;p<n;++p){let C=4*Math.round((t.fImgBuf[w+p]-e)/(l-e)*1e3);P[_++]=this.rgba[C++],P[_++]=this.rgba[C++],P[_++]=this.rgba[C++],P[_++]=this.rgba[C++]}}return f.putImageData(u,0,0),{url:o.toDataURL(),constRatio:t.fConstRatio,is_buf:!0}})}makeUrlFromPngBuf(t){let r=t.fPngBuf,a="";if("string"==typeof r)a=r;else for(let e=0;e<r.length;++e)a+=String.fromCharCode(r[e]<0?256+r[e]:r[e]);return Promise.resolve({url:"data:image/png;base64,"+(0,m.btoa_func)(a),constRatio:!0})}drawImage(){var l,i;let e,t=this.getObject(),r=this.getFramePainter(),a=r?r.getFrameRect():this.getPadPainter().getPadRect();return this.wheel_zoomy=!0,t._blob&&(15!=t._blob.length||t._blob[0]?3==t._blob.length&&t._blob[0]?(t.fPngBuf=t._blob[2],(null==(l=t.fPngBuf)?void 0:l.length)!=t._blob[1]&&(console.error(`TASImage with png buffer _blob error ${t._blob[1]} != ${null==(i=t.fPngBuf)?void 0:i.length}`),delete t.fPngBuf)):console.error(`TASImage _blob len ${t._blob.length} not recognized`):(t.fImageQuality=t._blob[1],t.fImageCompression=t._blob[2],t.fConstRatio=t._blob[3],t.fPalette={_typename:"TImagePalette",fUniqueID:t._blob[4],fBits:t._blob[5],fNumPoints:t._blob[6],fPoints:t._blob[7],fColorRed:t._blob[8],fColorGreen:t._blob[9],fColorBlue:t._blob[10],fColorAlpha:t._blob[11]},t.fWidth=t._blob[12],t.fHeight=t._blob[13],t.fImgBuf=t._blob[14],(t.fWidth*t.fHeight!=t.fImgBuf.length||t.fPalette.fNumPoints!=t.fPalette.fPoints.length)&&(console.error("TASImage _blob decoding error",t.fWidth*t.fHeight,"!=",t.fImgBuf.length,t.fPalette.fNumPoints,"!=",t.fPalette.fPoints.length),delete t.fImgBuf,delete t.fPalette)),delete t._blob),e=t.fImgBuf&&t.fPalette?this.makeUrlFromImageBuf(t,r):t.fPngBuf?this.makeUrlFromPngBuf(t):Promise.resolve({}),e.then(n=>(n.url&&this.createG(!!r).append("image").attr("href",n.url).attr("width",a.width).attr("height",a.height).attr("preserveAspectRatio",n.constRatio?null:"none"),n.url&&this.isMainPainter()&&n.is_buf&&r?this.drawColorPalette(this.options.Zscale,!0).then(()=>(r.setAxesRanges((0,m.create)("TAxis"),0,1,(0,m.create)("TAxis"),0,1,null,0,0),r.createXY({ndim:2,check_pad_range:!1}),r.addInteractivity())):this))}canZoomInside(t,r,a){let e=this.getObject();return!!(null==e?void 0:e.fImgBuf)&&("x"==t&&(a-r)*e.fWidth>3||"y"==t&&(a-r)*e.fHeight>3)}drawColorPalette(t,r){if(!this.isMainPainter())return Promise.resolve(null);if(!this.draw_palette){let i=(0,m.create)("TPave");Object.assign(i,{_typename:"TPaletteAxis",fName:"TPave",fH:null,fAxis:(0,m.create)("TGaxis"),fX1NDC:.91,fX2NDC:.95,fY1NDC:.1,fY2NDC:.9,fInit:1}),i.fAxis.fChopt="+",this.draw_palette=i,this.fPalette=!0}let a=this.getPadPainter().findPainterFor(this.draw_palette);if(!t)return a&&(a.Enabled=!1,a.removeG()),Promise.resolve(null);let e=this.getFramePainter();if(r&&e){let i=this.draw_palette;i.fX2NDC=e.fX2NDC+.01+(i.fX2NDC-i.fX1NDC),i.fX1NDC=e.fX2NDC+.01,i.fY1NDC=e.fY1NDC,i.fY2NDC=e.fY2NDC}if(a)return a.Enabled=!0,a.drawPave("");let l=this.selectCurrentPad(this.getPadName());return D.TPavePainter.draw(this.getDom(),this.draw_palette).then(i=>{a=i,this.selectCurrentPad(l),a.$secondary=!0,a.redraw=function(){}})}toggleColz(){let t=this.getObject();t&&t.fPalette&&(this.options.Zscale=!this.options.Zscale,this.drawColorPalette(this.options.Zscale,!0))}redraw(t){let r=this.draw_g?this.draw_g.select("image"):null,a=this.getFramePainter();if(!r||r.empty()||"zoom"===t||!a)return this.drawImage();r.attr("width",a.getFrameWidth()).attr("height",a.getFrameHeight())}clickButton(t){return!!this.isMainPainter()&&"ToggleColorZ"===t&&(this.toggleColz(),!0)}fillToolbar(){let t=this.getPadPainter(),r=this.getObject();t&&(null==r?void 0:r.fPalette)&&(t.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),t.showPadButtons())}static draw(t,r,a){let e=new c(t,r,a);return e.decodeOptions(a),(0,M.ensureTCanvas)(e,!1).then(()=>e.drawImage()).then(()=>(e.fillToolbar(),e))}}}}]);
//# sourceMappingURL=726.bc9a031ea10eaed4.js.map